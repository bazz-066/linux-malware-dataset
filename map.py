import pandas as pd
import os
import glob

os.chdir("/home/kosim/final_result/combined/")
ext = 'csv'
filenames = [i for i in glob.glob('*.{}'.format(ext))]

j = 1
for f in filenames:
    RuleName = []
    UtcTime = []
    ProcessGuid = []
    ProcessId = []
    Image = []
    User = []
    TargetFilename = []
    CreationUtcTime = []
    Hashes = []
    IsExecutable = []
    Archived = []
    FileVersion = []
    Description = []
    Product = []
    Company = []
    OriginalFileName = []
    CommandLine = []
    CurrentDirectory = []
    LogonGuid = []
    LogonId = []
    TerminalSessionId = []
    IntegrityLevel = []
    ParentProcessGuid = []
    ParentProcessId = []
    ParentImage = []
    ParentCommandLine = []
    ParentUser = []
    Protocol = []
    Initiated = []
    SourceIsIpv6 = []
    SourceIp = []
    SourceHostname = []
    SourcePort = []
    SourcePortName = []
    DestinationIsIpv6 = []
    DestinationIp = []
    DestinationHostname = []
    DestinationPort = []
    DestinationPortName = []
    SourceProcessGUID = []
    SourceProcessId = []
    SourceThreadId = []
    SourceImage = []
    TargetProcessGUID = []
    TargetProcessId = []
    TargetImage = []
    GrantedAccess = []
    CallTrace = []
    SourceUser = []
    TargetUser = []
    node_id = []
    parent_node_id = []
    label = []
    Signature = []
    SignatureStatus = []
    Signed = []
    ImageLoaded = []
    EventType = []
    PreviousCreationUtcTime = []
    ds = pd.read_csv(f)
    for index, row in ds.iterrows():
        if "RuleName" not in ds.keys():
            RuleName.append('')
        if "UtcTime" not in ds.keys():
            UtcTime.append('')
        if "ProcessGuid" not in ds.keys():
            ProcessGuid.append('')
        if "ProcessId" not in ds.keys():
            ProcessId.append('')
        if "Image" not in ds.keys():
            Image.append('')
        if "User" not in ds.keys():
            User.append('')
        if "TargetFilename" not in ds.keys():
            TargetFilename.append('')
        if "CreationUtcTime" not in ds.keys():
            CreationUtcTime.append('')
        if "Hashes" not in ds.keys():
            Hashes.append('')
        if "IsExecutable" not in ds.keys():
            IsExecutable.append('')
        if "Archived" not in ds.keys():
            Archived.append('')
        if "FileVersion" not in ds.keys():
            FileVersion.append('')
        if "Description" not in ds.keys():
            Description.append('')
        if "Product" not in ds.keys():
            Product.append('')
        if "Company" not in ds.keys():
            Company.append('')
        if "OriginalFileName" not in ds.keys():
            OriginalFileName.append('')
        if "CommandLine" not in ds.keys():
            CommandLine.append('')
        if "CurrentDirectory" not in ds.keys():
            CurrentDirectory.append('')
        if "LogonGuid" not in ds.keys():
            LogonGuid.append('')
        if "LogonId" not in ds.keys():
            LogonId.append('')
        if "TerminalSessionId" not in ds.keys():
            TerminalSessionId.append('')
        if "IntegrityLevel" not in ds.keys():
            IntegrityLevel.append('')
        if "ParentProcessGuid" not in ds.keys():
            ParentProcessGuid.append('')
        if "ParentProcessId" not in ds.keys():
            ParentProcessId.append('')
        if "ParentImage" not in ds.keys():
            ParentImage.append('')
        if "ParentCommandLine" not in ds.keys():
            ParentCommandLine.append('')
        if "ParentUser" not in ds.keys():
            ParentUser.append('')
        if "Protocol" not in ds.keys():
            Protocol.append('')
        if "Initiated" not in ds.keys():
            Initiated.append('')
        if "SourceIsIpv6" not in ds.keys():
            SourceIsIpv6.append('')
        if "SourceIp" not in ds.keys():
            SourceIp.append('')
        if "SourceHostname" not in ds.keys():
            SourceHostname.append('')
        if "SourcePort" not in ds.keys():
            SourcePort.append('')
        if "SourcePortName" not in ds.keys():
            SourcePortName.append('')
        if "DestinationIsIpv6" not in ds.keys():
            DestinationIsIpv6.append('')
        if "DestinationIp" not in ds.keys():
            DestinationIp.append('')
        if "DestinationHostname" not in ds.keys():
            DestinationHostname.append('')
        if "DestinationPort" not in ds.keys():
            DestinationPort.append('')
        if "DestinationPortName" not in ds.keys():
            DestinationPortName.append('')
        if "SourceProcessGUID" not in ds.keys():
            SourceProcessGUID.append('')
        if "SourceProcessId" not in ds.keys():
            SourceProcessId.append('')
        if "SourceThreadId" not in ds.keys():
            SourceThreadId.append('')
        if "SourceImage" not in ds.keys():
            SourceImage.append('')
        if "TargetProcessGUID" not in ds.keys():
            TargetProcessGUID.append('')
        if "TargetProcessId" not in ds.keys():
            TargetProcessId.append('')
        if "TargetImage" not in ds.keys():
            TargetImage.append('')
        if "GrantedAccess" not in ds.keys():
            GrantedAccess.append('')
        if "CallTrace" not in ds.keys():
            CallTrace.append('')
        if "SourceUser" not in ds.keys():
            SourceUser.append('')
        if "TargetUser" not in ds.keys():
            TargetUser.append('')
        node_id.append('')
        parent_node_id.append('')
        label.append('')
        Signature.append('')
        ImageLoaded.append('')
        SignatureStatus.append('')
        Signed.append('')
        EventType.append('')
        PreviousCreationUtcTime.append('')
    if "RuleName" not in ds.keys():
        ds["RuleName"] = RuleName
    if "UtcTime" not in ds.keys():
        ds["UtcTime"] = UtcTime
    if "ProcessGuid" not in ds.keys():
        ds["ProcessGuid"] = ProcessGuid
    if "ProcessId" not in ds.keys():
        ds["ProcessId"] = ProcessId
    if "Image" not in ds.keys():
        ds["Image"] = Image
    if "User" not in ds.keys():
        ds["User"] = User
    if "TargetFilename" not in ds.keys():
        ds["TargetFilename"] = TargetFilename
    if "CreationUtcTime" not in ds.keys():
        ds["CreationUtcTime"] = CreationUtcTime
    if "Hashes" not in ds.keys():
        ds["Hashes"] = Hashes
    if "IsExecutable" not in ds.keys():
        ds["IsExecutable"] = IsExecutable
    if "Archived" not in ds.keys():
        ds["Archived"] = Archived
    if "FileVersion" not in ds.keys():
        ds["FileVersion"] = FileVersion
    if "Description" not in ds.keys():
        ds["Description"] = Description
    if "Product" not in ds.keys():
        ds["Product"] = Product
    if "Company" not in ds.keys():
        ds["Company"] = Company
    if "OriginalFileName" not in ds.keys():
        ds["OriginalFileName"] = OriginalFileName
    if "CommandLine" not in ds.keys():
        ds["CommandLine"] = CommandLine
    if "CurrentDirectory" not in ds.keys():
        ds["CurrentDirectory"] = CurrentDirectory
    if "LogonGuid" not in ds.keys():
        ds["LogonGuid"] = LogonGuid
    if "LogonId" not in ds.keys():
        ds["LogonId"] = LogonId
    if "TerminalSessionId" not in ds.keys():
        ds["TerminalSessionId"] = TerminalSessionId
    if "IntegrityLevel" not in ds.keys():
        ds["IntegrityLevel"] = IntegrityLevel
    if "ParentProcessGuid" not in ds.keys():
        ds["ParentProcessGuid"] = ParentProcessGuid
    if "ParentProcessId" not in ds.keys():
        ds["ParentProcessId"] = ParentProcessId
    if "ParentImage" not in ds.keys():
        ds["ParentImage"] = ParentImage
    if "ParentCommandLine" not in ds.keys():
        ds["ParentCommandLine"] = ParentCommandLine
    if "ParentUser" not in ds.keys():
        ds["ParentUser"] = ParentUser
    if "Protocol" not in ds.keys():
        ds["Protocol"] = Protocol
    if "Initiated" not in ds.keys():
        ds["Initiated"] = Initiated
    if "SourceIsIpv6" not in ds.keys():
        ds["SourceIsIpv6"] = SourceIsIpv6
    if "SourceIp" not in ds.keys():
        ds["SourceIp"] = SourceIp
    if "SourceHostname" not in ds.keys():
        ds["SourceHostname"] = SourceHostname
    if "SourcePort" not in ds.keys():
        ds["SourcePort"] = SourcePort
    if "SourcePortName" not in ds.keys():
        ds["SourcePortName"] = SourcePortName
    if "DestinationIsIpv6" not in ds.keys():
        ds["DestinationIsIpv6"] = DestinationIsIpv6
    if "DestinationIp" not in ds.keys():
        ds["DestinationIp"] = DestinationIp
    if "DestinationHostname" not in ds.keys():
        ds["DestinationHostname"] = DestinationHostname
    if "DestinationPort" not in ds.keys():
        ds["DestinationPort"] = DestinationPort
    if "DestinationPortName" not in ds.keys():
        ds["DestinationPortName"] = DestinationPortName
    if "SourceProcessGUID" not in ds.keys():
        ds["SourceProcessGUID"] = SourceProcessGUID
    if "SourceProcessId" not in ds.keys():
        ds["SourceProcessId"] = SourceProcessId
    if "SourceThreadId" not in ds.keys():
        ds["SourceThreadId"] = SourceThreadId
    if "SourceImage" not in ds.keys():
        ds["SourceImage"] = SourceImage
    if "TargetProcessGUID" not in ds.keys():
        ds["TargetProcessGUID"] = TargetProcessGUID
    if "TargetProcessId" not in ds.keys():
        ds["TargetProcessId"] = TargetProcessId
    if "TargetImage" not in ds.keys():
        ds["TargetImage"] = TargetImage
    if "GrantedAccess" not in ds.keys():
        ds["GrantedAccess"] = GrantedAccess
    if "CallTrace" not in ds.keys():
        ds["CallTrace"] = CallTrace
    if "SourceUser" not in ds.keys():
        ds["SourceUser"] = SourceUser
    if "TargetUser" not in ds.keys():
        ds["TargetUser"] = TargetUser

    ds["node_id"] = node_id
    ds["parent_node_id"] = parent_node_id
    ds["label"] = label
    ds["Signature"] = Signature
    ds["ImageLoaded"] = ImageLoaded
    ds["SignatureStatus"] = SignatureStatus
    ds["Signed"] = Signed
    ds["EventType"] = EventType
    ds["PreviousCreationUtcTime"] = PreviousCreationUtcTime

    # Get data without event id 10 and 23, 
    # Anticipate discrepancies in training data because training data does not have EventID 10 and 23.
    # Comment 2 lines below to get all EventID. 
    ds = ds[ds["EventID"] != 10]
    ds = ds[ds["EventID"] != 23]

    res = ds[[
            "Provider_Name", 
            "Description",
            "IntegrityLevel",
            "LogonGuid",
            "LogonId",
            "ParentProcessGuid",
            "ParentProcessId",
            "ProcessGuid",
            "ProcessId",
            "Channel",
            "TerminalSessionId",
            "User",
            "EventID",
            "UtcTime",
            "SourceHostname",
            "node_id",
            "TimeCreated_SystemTime",
            "parent_node_id",
            "label",
            "Image",
            "FileVersion",
            "ImageLoaded",
            "OriginalFileName",
            "Signature",
            "SignatureStatus",
            "Signed",
            "EventType",
            "RuleName",
            "TargetFilename",
            "DestinationHostname",
            "DestinationIp",
            "DestinationPort",
            "DestinationPortName",
            "Initiated",
            "Protocol",
            "SourcePortName",
            "TargetFilename",
            "TargetProcessGUID",
            "TargetImage",
            "CommandLine",
            "CreationUtcTime",
            "PreviousCreationUtcTime"
            ]]

    res.rename(columns={
        "Provider_Name": "Company",
        "Description": "Description",
        "IntegrityLevel": "IntegrityLevel",
        "LogonGuid": "LogonGuid",
        "LogonId": "LogonId",
        "ParentProcessGuid": "ParentProcessGuid",
        "ParentProcessId": "ParentProcessId",
        "ProcessGuid": "ProcessGuid",
        "ProcessId": "ProcessId",
        "Channel": "Product",
        "TerminalSessionId": "TerminalSessionId",
        "User": "User",
        "EventID": "EventID",
        "UtcTime": "UtcTime",
        "SourceHostname": "host_name",
        "node_id": "node_id",
        "TimeCreated_SystemTime": "timestamp",
        "parent_node_id": "parent_node_id",
        "label": "label",
        "Image": "Image",
        "FileVersion": "FileVersion",
        "ImageLoaded": "ImageLoaded",
        "OriginalFileName": "OriginalFileName",
        "Signature": "Signature",
        "SignatureStatus": "SignatureStatus",
        "Signed": "Signed",
        "EventType": "EventType",
        "RuleName": "RuleName",
        "TargetFilename": "TargetObject",
        "DestinationHostname": "DestinationHostname",
        "DestinationIp": "DestinationIp",
        "DestinationPort": "DestinationPort",
        "DestinationPortName": "DestinationPortName",
        "Initiated": "Initiated",
        "Protocol": "Protocol",
        "SourcePortName": "SourcePortName",
        "TargetFilename": "TargetFilename",
        "TargetProcessGUID": "TargetProcessGuid",
        "TargetImage": "TargetImage",
        "CommandLine": "StartFunction",
        "CreationUtcTime": "CreationUtcTime",
        "PreviousCreationUtcTime": "PreviousCreationUtcTime"
    }, inplace = True)
    res.to_csv("/home/kosim/final_result/mapped/" + str(j) + "_mapped_result_windows_event.csv", index=False, encoding='utf-8-sig')
    j += 1